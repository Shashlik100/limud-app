<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>××¢×§×‘ ×œ×™××•×“</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { margin: 0; font-family: 'Heebo', Arial, sans-serif; background: #f8fafc; color: #1a202c; direction: rtl; }
    /* ... (×”- CSS ×©×œ×š, ×œ× × ×•×’×¢) ... */
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- ×˜×¢×™× ×” × ×›×•× ×” ×©×œ Hebcal (×œ× ×œ×’×¢×ª) -->
  <script src="https://cdn.jsdelivr.net/npm/@hebcal/core/dist/bundle.min.js"></script>
</head>
<body>
  <div class="app-container">
    <!-- ... (×”×ª×¤×¨×™×˜, ×˜×‘×œ××•×ª, ×•×›×•' - ×”×›×œ × ×©××¨) ... -->
    <aside class="sidebar">
      <h2>××¢×§×‘ ×œ×™××•×“</h2>
      <div class="categories" id="categories"></div>
      <form class="add-category-form" id="add-category-form" autocomplete="off">
        <button type="submit">+</button>
        <input type="text" id="new-category" placeholder="×”×•×¡×£ ×§×˜×’×•×¨×™×”..." maxlength="18">
      </form>
    </aside>
    <main class="main" id="main-content"></main>
  </div>
  <script>
    // ××¦×™×’ ×ª××¨×™×š ×¢×‘×¨×™/×œ×•×¢×–×™
    let useHebrewDates = false;
   function formatDate(dateStr) {
  if(!dateStr) return "";
  if (!useHebrewDates) {
    const [year, month, day] = dateStr.split("-");
    return `${day}-${month}-${year}`;
  } else {
    try {
      const [year, month, day] = dateStr.split("-");
      // ×‘×“×™×§×” ×©×”×ª××¨×™×š ×ª×§×™×Ÿ (×”×›×œ ××¡×¤×¨×™×, ×™×© 3 ×—×œ×§×™×)
      if (
        !year || !month || !day ||
        isNaN(+year) || isNaN(+month) || isNaN(+day)
      ) {
        return "[×©×’×™××” ×‘×ª××¨×™×š]";
      }
      // ×‘×“×™×§×” ×©×”×¡×¤×¨×™×” ×˜×¢×•× ×”
      if (typeof Hebcal === "object" && typeof Hebcal.HDate === "function") {
        const dt = new Hebcal.HDate(new Date(+year, +month-1, +day));
        return dt.renderHebrewDate("h");
      } else {
        return "[Hebcal ×œ× × ×˜×¢×Ÿ]";
      }
    } catch(e) {
      return "[×©×’×™××” ×‘×ª××¨×™×š]";
    }
  }
}

    // ×©××¨ ×”×§×•×“ ×©×œ×š ×‘×“×™×•×§ ×›×¤×™ ×©×”×•×:
    const DEFAULT_CATEGORIES = [
      "×ª×•×¨×”", "× ×‘×™××™×", "×›×ª×•×‘×™×", "××©× ×”", "×’××¨×", "×’××•× ×™×",
      "×¨××©×•× ×™×", "××—×¨×•× ×™×", "××•×¡×¨"
    ];
    let selectedCategory = null;
    let pieChart, lineChart;
    let runningTimers = {};

    function getCategories() {
      let custom = JSON.parse(localStorage.getItem('customCategories') || '[]');
      return [...DEFAULT_CATEGORIES, ...custom];
    }
    function setCustomCategories(arr) {
      localStorage.setItem('customCategories', JSON.stringify(arr));
    }
    function getEntries() {
      return JSON.parse(localStorage.getItem('studyEntries') || '[]');
    }
    function setEntries(arr) {
      localStorage.setItem('studyEntries', JSON.stringify(arr));
    }

    function renderCategories() {
      const cats = getCategories();
      const cont = document.getElementById('categories');
      cont.innerHTML = "";
      cats.forEach(cat => {
        const div = document.createElement('div');
        div.className = 'category' + (selectedCategory === cat ? ' selected' : '') +
          (DEFAULT_CATEGORIES.includes(cat) ? '' : ' custom');
        div.textContent = cat;
        if (!DEFAULT_CATEGORIES.includes(cat)) {
          const btn = document.createElement('button');
          btn.className = "remove-btn";
          btn.title = "×”×¡×¨ ×§×˜×’×•×¨×™×”";
          btn.textContent = "âœ–";
          btn.onclick = (e) => {
            e.stopPropagation();
            removeCategory(cat);
          };
          div.appendChild(btn);
        }
        div.onclick = () => {
          selectedCategory = cat;
          renderCategories();
          renderMain();
        };
        cont.appendChild(div);
      });
      if (!selectedCategory) selectedCategory = null;
    }
    document.getElementById('add-category-form').onsubmit = function(e){
      e.preventDefault();
      const val = document.getElementById('new-category').value.trim();
      if(!val || getCategories().includes(val)) return;
      let custom = JSON.parse(localStorage.getItem('customCategories') || '[]');
      custom.push(val);
      setCustomCategories(custom);
      document.getElementById('new-category').value = "";
      renderCategories();
    };
    function removeCategory(cat) {
      let custom = JSON.parse(localStorage.getItem('customCategories') || '[]');
      custom = custom.filter(c => c !== cat);
      setCustomCategories(custom);
      let entries = getEntries().filter(e => e.category !== cat);
      setEntries(entries);
      if (selectedCategory === cat) selectedCategory = null;
      renderCategories();
      renderMain();
      updateCharts();
    }

    function renderMain() {
      const main = document.getElementById('main-content');
      if (!selectedCategory) {
        main.innerHTML = `
          <div class="header">×¡×™×›×•× ×œ×™××•×“</div>
          <div class="dashboard-graphs">
            <div>
              <canvas id="pieChart"></canvas>
              <div style="margin-top: 8px;font-weight:600;font-size:1.07em">×”×ª×¤×œ×’×•×ª ×œ×¤×™ ×§×˜×’×•×¨×™×”</div>
            </div>
            <div>
              <canvas id="lineChart"></canvas>
              <div style="margin-top: 8px;font-weight:600;font-size:1.07em">×”×ª×§×“××•×ª ×™×•××™×ª</div>
            </div>
          </div>
          <button class="add-btn" onclick="openEntryModal()">+ ×”×•×¡×£ ×œ×™××•×“</button>
          <div style="margin-right:45px;">
            <button class="toggle-date-btn" onclick="toggleDateFormat(); return false;">
              ${useHebrewDates ? "×”×¦×’ ×ª××¨×™×š ×œ×•×¢×–×™" : "×”×¦×’ ×ª××¨×™×š ×¢×‘×¨×™"}
            </button>
          </div>
          <div class="entries-table-container" id="entries-table-container"></div>
        `;
        renderEntries(); updateCharts();
      } else {
        main.innerHTML = `
          <div style="display:flex;align-items:center;gap:20px;margin:22px 0 16px 0;padding-right:34px;">
            <button onclick="backToMain()" style="background:#e2e8f0;border:none;color:#283048;font-weight:700;border-radius:9px;padding:7px 22px;cursor:pointer;font-size:1em;">×—×–×•×¨</button>
            <span class="header" style="margin:0;">${selectedCategory}</span>
          </div>
          <button class="add-btn" onclick="openEntryModalForCat('${selectedCategory.replace(/'/g,"\\'")}')">+ ×”×•×¡×£ ×œ×™××•×“</button>
          <div style="margin-right:45px;">
            <button class="toggle-date-btn" onclick="toggleDateFormat(); return false;">
              ${useHebrewDates ? "×”×¦×’ ×ª××¨×™×š ×œ×•×¢×–×™" : "×”×¦×’ ×ª××¨×™×š ×¢×‘×¨×™"}
            </button>
          </div>
          <div class="entries-table-container" id="entries-table-container"></div>
        `;
        renderEntries(selectedCategory);
      }
    }
    function toggleDateFormat() {
      useHebrewDates = !useHebrewDates;
      renderMain();
    }
    function backToMain() {
      selectedCategory = null;
      renderCategories();
      renderMain();
    }

    function renderEntries(catFilter = null) {
      let entries = getEntries();
      let filtered = catFilter ? entries.filter(e => e.category === catFilter) : entries;
      const cont = document.getElementById('entries-table-container');
      let html = "<table><thead><tr>";
      html += "<th>×ª××¨×™×š</th><th>×§×˜×’×•×¨×™×”</th><th>×¡×¤×¨/× ×•×©×</th><th>×¤×¨×§/×“×£</th><th>×“×§×•×ª</th><th>×”×¢×¨×•×ª</th><th></th></tr></thead><tbody>";
      if(filtered.length === 0){
        html += `<tr><td colspan="7" style="text-align:center;color:#aaa">××™×Ÿ × ×ª×•× ×™×</td></tr>`;
      } else {
        filtered.forEach((e,i) => {
          html += `<tr>
            <td>${formatDate(e.date)}</td>
            <td>${e.category}</td>
            <td>${e.title}</td>
            <td>${e.unit}</td>
            <td id="min-cell-${e.id}">
              ${typeof e.minutes === "number" && e.minutes > 0 ? e.minutes : ""}
            </td>
            <td>${e.notes||''}</td>
            <td>
              <button class="edit-btn" title="×¢×¨×•×š" onclick="editEntry(${e.id})">âœï¸</button>
              <button class="del-btn" title="××—×§" onclick="delEntry(${e.id})">ğŸ—‘ï¸</button>
              <button class="timer-btn" id="timer-btn-${e.id}" onclick="handleTimerBtn(${e.id})">
                ${runningTimers[e.id] ? "×¡×™×™×" : "â±ï¸"}
              </button>
              <span id="timer-show-${e.id}" style="font-size:0.95em;font-weight:600;margin-right:6px;"></span>
            </td>
          </tr>`;
        });
      }
      html += "</tbody></table>";
      cont.innerHTML = html;

      // ×¢×“×›×•×Ÿ ×©×¢×•×Ÿ ×¨×™×¦×” ×× ×™×©
      filtered.forEach((e) => {
        if (runningTimers[e.id]) {
          updateRowTimerDisplay(e.id);
          runningTimers[e.id].intervalId = setInterval(() => updateRowTimerDisplay(e.id), 1000);
        }
      });
    }

    function handleTimerBtn(id) {
      if (runningTimers[id]) {
        clearInterval(runningTimers[id].intervalId);
        let elapsed = Math.floor((Date.now() - runningTimers[id].startTime) / 1000);
        let mins = Math.max(1, Math.round(elapsed / 60));
        let entries = getEntries().map(e =>
          e.id === id ? { ...e, minutes: mins } : e
        );
        setEntries(entries);
        delete runningTimers[id];
        renderEntries(selectedCategory);
        updateCharts();
      } else {
        runningTimers[id] = {
          startTime: Date.now(),
          intervalId: null
        };
        updateRowTimerDisplay(id);
        runningTimers[id].intervalId = setInterval(() => updateRowTimerDisplay(id), 1000);
        document.getElementById("timer-btn-" + id).textContent = "×¡×™×™×";
      }
    }

    function updateRowTimerDisplay(id) {
      if (!runningTimers[id]) return;
      let elapsed = Math.floor((Date.now() - runningTimers[id].startTime) / 1000);
      let hrs = Math.floor(elapsed / 3600);
      let mins = Math.floor((elapsed % 3600) / 60);
      let secs = elapsed % 60;
      let el = document.getElementById("timer-show-" + id);
      if (el) el.textContent = `${hrs.toString().padStart(2,'0')}:${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;
    }

    function openEntryModal(editId=null, forceCategory=null) {
      let cats = getCategories();
      let entry = editId!==null ? getEntries().find(e=>e.id===editId) : {};
      let modal = document.createElement('div');
      modal.className = "modal-bg";
      modal.innerHTML = `<form class="modal" id="entryForm">
        <label>×§×˜×’×•×¨×™×”
          <select id="cat-sel" required ${forceCategory?'disabled':''}>
            ${cats.map(cat=>
              `<option ${((entry.category===cat)||forceCategory===cat)?'selected':''}>${cat}</option>`
            ).join("")}
          </select>
        </label>
        <label>×ª××¨×™×š
          <input type="date" id="date-inp" required value="${entry.date||new Date().toISOString().slice(0,10)}">
        </label>
        <label>×¡×¤×¨/× ×•×©×
          <input type="text" id="title-inp" maxlength="24" required value="${entry.title||''}">
        </label>
        <label>×¤×¨×§/×“×£
          <input type="text" id="unit-inp" maxlength="14" value="${entry.unit||''}">
        </label>
        <label>×“×§×•×ª
          <input type="number" id="minutes-inp" min="1" max="999" value="${entry.minutes||''}">
        </label>
        <label>×”×¢×¨×•×ª
          <textarea id="notes-inp" maxlength="100">${entry.notes||''}</textarea>
        </label>
        <div class="modal-btns">
          <button type="submit" class="ok-btn">${editId!==null?"×©××•×¨":"×”×•×¡×£"}</button>
          <button type="button" class="cancel-btn" onclick="this.closest('.modal-bg').remove()">×‘×™×˜×•×œ</button>
        </div>
      </form>`;
      document.body.appendChild(modal);

      document.getElementById('entryForm').onsubmit = function(e){
        e.preventDefault();
        let ent = {
          category: forceCategory||document.getElementById('cat-sel').value,
          date: document.getElementById('date-inp').value,
          title: document.getElementById('title-inp').value,
          unit: document.getElementById('unit-inp').value,
          minutes: +document.getElementById('minutes-inp').value || null,
          notes: document.getElementById('notes-inp').value,
          id: editId!==null ? editId : Date.now()
        };
        let entries = getEntries();
        if(editId!==null) {
          entries = entries.map(e => e.id===editId ? ent : e);
        } else {
          entries.push(ent);
        }
        setEntries(entries);
        updateCharts();
        renderMain();
        modal.remove();
      };
    }
    function openEntryModalForCat(cat) {
      openEntryModal(null, cat);
    }
    function editEntry(id) { openEntryModal(id); }
    function delEntry(id) {
      if(!confirm("×œ××—×•×§ ×œ×™××•×“ ×–×”?")) return;
      let entries = getEntries().filter(e=>e.id!==id);
      setEntries(entries);
      updateCharts();
      renderMain();
    }

    function updateCharts() {
      let entries = getEntries();
      let byCat = {};
      getCategories().forEach(cat=>byCat[cat]=0);
      entries.forEach(e=>byCat[e.category]=(byCat[e.category]||0)+(+e.minutes||0));
      let pieData = {
        labels: Object.keys(byCat),
        datasets: [{
          data: Object.values(byCat),
          backgroundColor: [
            "#63b3ed","#f687b3","#68d391","#f6ad55","#90cdf4","#fbb6ce","#4fd1c5","#feb2b2","#cbd5e1","#fef08a","#b5f4ff"
          ],
        }]
      };
      if(document.getElementById('pieChart')) {
        if(pieChart) pieChart.destroy();
        pieChart = new Chart(document.getElementById('pieChart'), {
          type: 'pie',
          data: pieData,
          options: {
            plugins: { legend: { position: 'bottom', labels: { font: { family: 'Heebo,Arial', size:14 }}}},
          }
        });
      }
      let byDate = {};
      entries.forEach(e=>{
        byDate[e.date]= (byDate[e.date]||0) + (+e.minutes||0);
      });
      let dates = Object.keys(byDate).sort();
      let lineData = {
        labels: dates,
        datasets: [{
          label: '×“×§×•×ª ×œ×™××•×“',
          data: dates.map(d=>byDate[d]),
          fill: false,
          borderColor: "#4299e1",
          tension: 0.3,
          pointRadius: 5,
        }]
      };
      if(document.getElementById('lineChart')) {
        if(lineChart) lineChart.destroy();
        lineChart = new Chart(document.getElementById('lineChart'), {
          type: 'line',
          data: lineData,
          options: {
            plugins: { legend: { display: false }},
            scales: { y: { beginAtZero: true }},
          }
        });
      }
    }

    function init() {
      renderCategories();
      renderMain();
      updateCharts();
    }
    window.onload = init;
  </script>
</body>
</html>
